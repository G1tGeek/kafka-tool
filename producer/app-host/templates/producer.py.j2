import requests
from kafka import KafkaProducer
import json

# Kafka configuration
kafka_broker = '{{{ kafka_host }}:9092'  # Broker address
topic_name = 'API'  # Topic to send data to

# Fetch weather data from the API
url = "https://weather.visualcrossing.com/VisualCrossingWebServices/rest/services/timeline/meerut?unitGroup=metric&key=N9QJNA6A4HB8FTKQ3URMAGBQS&contentType=json"

# Send a request to the API
response = requests.get(url)

if response.status_code == 200:
    weather_data = response.json()  # Parse the JSON response
    
    # Initialize Kafka producer
    producer = KafkaProducer(
        bootstrap_servers=kafka_broker,
        value_serializer=lambda v: json.dumps(v).encode('utf-8')  # Serialize the data to JSON
    )
    
    # Send the weather data to the Kafka topic
    producer.send(topic_name, value=weather_data)
    producer.flush()  # Ensure data is sent before exiting
    print(f"Data sent to topic {topic_name}")
    
else:
    print(f"Failed to fetch data. Status code: {response.status_code}")
