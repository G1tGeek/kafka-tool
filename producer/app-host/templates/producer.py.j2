import time
import requests
from kafka import KafkaProducer
import json


kafka_broker = '{{ kafka_host }}:9092'  # Broker address
topic_name = 'API'  # Topic to send data to


def fetch_and_send_data():
    url = "https://api.tomorrow.io/v4/weather/forecast?location=42.3478,-71.0466&apikey=rU7aKOmGD3GVFqfn2DiYgiqgPUIuYvAI"

    response = requests.get(url)

    if response.status_code == 200:
        weather_data = response.json()  # Parse the JSON response
        
      
        producer = KafkaProducer(
            bootstrap_servers=kafka_broker,
            value_serializer=lambda v: json.dumps(v).encode('utf-8')  # Serialize the data to JSON
        )
        
        
        producer.send(topic_name, value=weather_data)
        producer.flush()  # Ensure data is sent before exiting
        print(f"Data sent to topic {topic_name}")
    else:
        print(f"Failed to fetch data. Status code: {response.status_code}")


fetch_and_send_data()


while True:
    time.sleep(4 * 60 * 60) 
    fetch_and_send_data()
